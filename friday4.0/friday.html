<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta http-equiv="Permissions-Policy" content="camera=*; microphone=*">
<title>Friday</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@200;300;400;500&family=DM+Mono:wght@400;500&display=swap');

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body {
  width:100%; height:100%; overflow:hidden;
  background:#000; color:#fff;
  font-family:'DM Sans', sans-serif;
  user-select:none;
}

/* â”€â”€ FULL SCREEN CAMERA â”€â”€ */
#vid {
  position:fixed; inset:0;
  width:100%; height:100%;
  object-fit:cover; z-index:0;
  transition:filter .8s ease;
}
#vid.dim { filter:brightness(.28) blur(2px); }

/* â”€â”€ OVERLAYS â”€â”€ */
.vig {
  position:fixed; inset:0; z-index:1; pointer-events:none;
  background:radial-gradient(ellipse at center, transparent 38%, rgba(0,0,0,.72) 100%);
}
#gTop {
  position:fixed; top:0; left:0; right:0; height:200px;
  z-index:1; pointer-events:none;
  background:linear-gradient(to bottom, rgba(0,0,0,.85), transparent);
}
#gBot {
  position:fixed; bottom:0; left:0; right:0; height:340px;
  z-index:1; pointer-events:none;
  background:linear-gradient(to top, rgba(0,0,0,.97) 0%, rgba(0,0,0,.5) 50%, transparent 100%);
}

/* â”€â”€ HUD CORNERS â”€â”€ */
.hc { position:fixed; width:20px; height:20px; z-index:5; opacity:0; transition:opacity .6s; }
.hc.on { opacity:.42; }
.tl { top:14px; left:14px; border-top:1.5px solid #8ab4f8; border-left:1.5px solid #8ab4f8; }
.tr { top:14px; right:14px; border-top:1.5px solid #8ab4f8; border-right:1.5px solid #8ab4f8; }
.bl { bottom:225px; left:14px; border-bottom:1.5px solid #8ab4f8; border-left:1.5px solid #8ab4f8; }
.br { bottom:225px; right:14px; border-bottom:1.5px solid #8ab4f8; border-right:1.5px solid #8ab4f8; }

/* â”€â”€ ORB â”€â”€ */
#orbWrap {
  position:fixed; z-index:6;
  top:42%; left:50%; transform:translate(-50%,-50%);
  opacity:0; transition:opacity .9s;
}
#orbWrap.on { opacity:1; }
#orbGlow {
  position:absolute; top:50%; left:50%;
  transform:translate(-50%,-50%);
  width:290px; height:290px; border-radius:50%;
  background:conic-gradient(from 0deg, #4facfe, #667eea, #f093fb, #4facfe);
  filter:blur(40px); opacity:.28;
  animation:glowSpin 10s linear infinite;
}
@keyframes glowSpin {
  from { transform:translate(-50%,-50%) rotate(0deg); }
  to   { transform:translate(-50%,-50%) rotate(360deg); }
}
#orb {
  width:195px; height:195px; border-radius:50%;
  position:relative; z-index:1;
  background:radial-gradient(circle at 33% 30%, #4facfe 0%, #00f2fe 18%, #667eea 48%, #764ba2 73%, #f093fb 100%);
  box-shadow:0 0 55px rgba(79,172,254,.45), 0 0 90px rgba(102,126,234,.2);
  transition:all .35s ease;
}
#orb.idle     { animation:orbFloat 4.5s ease-in-out infinite; }
#orb.listening {
  background:radial-gradient(circle at 33% 30%, #ff6b6b, #f28b82, #ff4757, #c0392b);
  box-shadow:0 0 80px rgba(242,139,130,.8), 0 0 120px rgba(242,139,130,.3);
  animation:orbPulse 1s ease-in-out infinite;
}
#orb.thinking {
  background:radial-gradient(circle at 33% 30%, #4facfe, #667eea, #8ab4f8);
  box-shadow:0 0 80px rgba(138,180,248,.8);
  animation:orbSpin 2.2s linear infinite;
}
#orb.speaking {
  background:radial-gradient(circle at 33% 30%, #00f2fe, #81c995, #11998e, #38ef7d);
  box-shadow:0 0 80px rgba(129,201,149,.8), 0 0 110px rgba(129,201,149,.25);
  animation:orbMorph 1s ease-in-out infinite;
}
@keyframes orbFloat  { 0%,100%{transform:translateY(0) scale(1)} 50%{transform:translateY(-14px) scale(1.03)} }
@keyframes orbPulse  { 0%,100%{transform:scale(1)} 50%{transform:scale(1.14)} }
@keyframes orbSpin   { from{filter:hue-rotate(0deg)} to{filter:hue-rotate(360deg)} }
@keyframes orbMorph  { 0%,100%{border-radius:50%} 25%{border-radius:46% 54% 50% 50%} 50%{border-radius:50% 50% 44% 56%} 75%{border-radius:55% 45% 55% 45%} }

/* â”€â”€ REPLY TEXT â”€â”€ */
#replyArea {
  position:fixed; z-index:8;
  left:50%; transform:translateX(-50%);
  bottom:215px; width:min(600px, 90vw);
  text-align:center;
  opacity:0; transition:opacity .4s;
  pointer-events:none;
}
#replyArea.on { opacity:1; }
#replyTxt {
  font-size:1.08rem; font-weight:300; line-height:1.75;
  color:rgba(255,255,255,.95);
  text-shadow:0 2px 20px rgba(0,0,0,.95);
}

/* â”€â”€ WAVEFORM â”€â”€ */
#wave {
  display:flex; align-items:center; justify-content:center;
  gap:3px; height:26px; margin-top:12px;
  opacity:0; transition:opacity .3s;
}
#wave.on { opacity:1; }
.wb {
  width:3px; border-radius:2px; background:#8ab4f8;
  animation:wbAnim .75s ease-in-out infinite;
}
.wb:nth-child(1){height:4px;  animation-delay:0s}
.wb:nth-child(2){height:11px; animation-delay:.07s}
.wb:nth-child(3){height:20px; animation-delay:.14s}
.wb:nth-child(4){height:26px; animation-delay:.21s}
.wb:nth-child(5){height:20px; animation-delay:.14s}
.wb:nth-child(6){height:11px; animation-delay:.07s}
.wb:nth-child(7){height:4px;  animation-delay:0s}
@keyframes wbAnim { 0%,100%{transform:scaleY(1);opacity:.4} 50%{transform:scaleY(1.7);opacity:1} }

/* â”€â”€ STATUS â”€â”€ */
#status {
  position:fixed; z-index:8;
  bottom:178px; left:50%; transform:translateX(-50%);
  font-size:.66rem; color:rgba(255,255,255,.38);
  letter-spacing:.14em; text-transform:uppercase;
  font-family:'DM Mono',monospace;
  opacity:0; transition:opacity .4s; white-space:nowrap;
}
#status.on { opacity:1; }

/* â”€â”€ LOGO â”€â”€ */
#logo {
  position:fixed; top:20px; left:20px; z-index:10;
  display:flex; align-items:center; gap:9px;
  opacity:0; transition:opacity .6s .4s;
}
#logo.on { opacity:1; }
#logoMark { font-size:.9rem; color:#8ab4f8; }
#logoName { font-size:.78rem; font-weight:500; color:rgba(255,255,255,.75); letter-spacing:.12em; }
#livePill {
  display:flex; align-items:center; gap:5px;
  padding:3px 9px; border-radius:12px;
  background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.09);
  font-size:.58rem; color:rgba(255,255,255,.45); letter-spacing:.06em;
}
#liveDot {
  width:6px; height:6px; border-radius:50%;
  background:#81c995; box-shadow:0 0 7px #81c995;
  animation:dotBlink 2s infinite;
}
@keyframes dotBlink { 0%,100%{opacity:1} 50%{opacity:.15} }

/* â”€â”€ WAKE BADGE â”€â”€ */
#wakeBadge {
  position:fixed; top:20px; right:68px; z-index:10;
  padding:5px 12px; border-radius:14px;
  background:rgba(0,0,0,.5); border:1px solid rgba(138,180,248,.2);
  font-size:.6rem; color:rgba(138,180,248,.7);
  letter-spacing:.07em; font-family:'DM Mono',monospace;
  opacity:0; transition:opacity .5s;
}
#wakeBadge.on { opacity:1; }

/* â”€â”€ GEAR BUTTON â”€â”€ */
#gear {
  position:fixed; top:16px; right:16px; z-index:10;
  width:38px; height:38px; border-radius:50%;
  background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.09);
  color:rgba(255,255,255,.55); font-size:.9rem; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  backdrop-filter:blur(14px);
  opacity:0; transition:opacity .5s .5s;
}
#gear.on { opacity:1; }
#gear:hover { background:rgba(255,255,255,.1); color:#fff; }

/* â”€â”€ SIDE BUTTONS â”€â”€ */
#side {
  position:fixed; right:18px; top:50%; transform:translateY(-50%);
  z-index:10; display:flex; flex-direction:column; gap:12px;
  opacity:0; transition:opacity .5s .5s;
}
#side.on { opacity:1; }
.sBtn {
  width:48px; height:48px; border-radius:50%;
  background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.09);
  color:rgba(255,255,255,.6); font-size:1.05rem; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  backdrop-filter:blur(12px); transition:.2s;
}
.sBtn:hover, .sBtn:active { background:rgba(255,255,255,.12); color:#fff; transform:scale(1.07); }

/* â”€â”€ FLIP â”€â”€ */
#flipBtn {
  position:fixed; left:18px; bottom:90px; z-index:10;
  width:44px; height:44px; border-radius:50%;
  background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.08);
  color:rgba(255,255,255,.55); font-size:.95rem; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  backdrop-filter:blur(12px);
  opacity:0; transition:opacity .5s .5s;
}
#flipBtn.on { opacity:1; }
#flipBtn:hover { background:rgba(255,255,255,.1); color:#fff; }

/* â”€â”€ BIG MIC BUTTON â”€â”€ */
#micWrap {
  position:fixed; bottom:64px; left:50%; transform:translateX(-50%);
  z-index:10; display:flex; flex-direction:column; align-items:center; gap:10px;
  opacity:0; transition:opacity .5s .6s;
}
#micWrap.on { opacity:1; }
#mic {
  width:78px; height:78px; border-radius:50%;
  background:rgba(255,255,255,.07);
  border:1.5px solid rgba(255,255,255,.18);
  color:#fff; font-size:1.75rem; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  backdrop-filter:blur(20px);
  box-shadow:0 8px 32px rgba(0,0,0,.55);
  transition:all .2s;
}
#mic:hover, #mic:active { background:rgba(255,255,255,.14); transform:scale(1.06); }
#mic.listening {
  background:rgba(242,139,130,.16); border-color:#f28b82;
  animation:micRing 1.2s ease-in-out infinite;
}
#mic.thinking  { background:rgba(138,180,248,.1); border-color:#8ab4f8; }
#mic.speaking  { background:rgba(129,201,149,.1); border-color:#81c995; }
@keyframes micRing {
  0%  { box-shadow:0 0 0 0 rgba(242,139,130,.55); }
  70% { box-shadow:0 0 0 22px rgba(242,139,130,0); }
  100%{ box-shadow:0 0 0 0 rgba(242,139,130,0); }
}
#micLbl {
  font-size:.65rem; color:rgba(255,255,255,.38);
  letter-spacing:.12em; text-transform:uppercase;
  font-family:'DM Mono',monospace;
}

/* â”€â”€ CHIPS â”€â”€ */
#chips {
  position:fixed; bottom:22px; left:50%; transform:translateX(-50%);
  z-index:9; display:flex; gap:6px;
  opacity:0; transition:opacity .5s .7s;
}
#chips.on { opacity:1; }
.chip {
  padding:4px 11px; border-radius:14px;
  background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.06);
  font-size:.6rem; color:rgba(255,255,255,.3);
  letter-spacing:.06em; font-family:'DM Mono',monospace;
}

/* â”€â”€ FLASH â”€â”€ */
#flash {
  position:fixed; inset:0; background:#fff;
  opacity:0; z-index:50; pointer-events:none;
  transition:opacity .08s;
}

/* â”€â”€ START SCREEN â”€â”€ */
#start {
  position:fixed; inset:0; z-index:100; background:#000;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  gap:18px; transition:opacity .7s;
}
#start.hide { opacity:0; pointer-events:none; }
.stOrb {
  width:140px; height:140px; border-radius:50%;
  background:radial-gradient(circle at 33% 30%, #4facfe 0%, #00f2fe 18%, #667eea 48%, #764ba2 73%, #f093fb 100%);
  box-shadow:0 0 55px rgba(79,172,254,.5);
  animation:orbFloat 3.5s ease-in-out infinite;
}
.stTitle { font-size:1.9rem; font-weight:300; letter-spacing:.14em; color:rgba(255,255,255,.92); }
.stSub   { font-size:.82rem; color:rgba(255,255,255,.28); max-width:240px; text-align:center; line-height:1.65; }
#startBtn {
  padding:13px 42px; border-radius:28px;
  background:linear-gradient(135deg, #667eea, #764ba2);
  color:#fff; border:none; font-size:.92rem; font-weight:500;
  cursor:pointer; transition:.2s; letter-spacing:.04em;
  font-family:'DM Sans',sans-serif;
}
#startBtn:hover, #startBtn:active { transform:scale(1.05); opacity:.9; }

/* â”€â”€ SETTINGS PANEL â”€â”€ */
#sOv { position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:198; display:none; }
#sOv.on { display:block; }
#sPan {
  position:fixed; top:0; right:0; bottom:0; width:min(300px,90vw);
  background:rgba(5,5,8,.98); border-left:1px solid rgba(255,255,255,.06);
  z-index:199; overflow-y:auto; padding:22px;
  transform:translateX(100%); transition:transform .3s cubic-bezier(.4,0,.2,1);
}
#sPan.on { transform:translateX(0); }
.sHead {
  font-size:.92rem; font-weight:500; margin-bottom:20px;
  display:flex; align-items:center; justify-content:space-between; color:#fff;
}
.sClose {
  width:28px; height:28px; border-radius:50%;
  background:rgba(255,255,255,.07); border:none; color:#666;
  cursor:pointer; font-size:.85rem;
  display:flex; align-items:center; justify-content:center;
}
.sClose:hover { color:#fff; }
.sLbl {
  font-size:.62rem; color:#444; letter-spacing:.1em;
  text-transform:uppercase; font-family:'DM Mono',monospace;
  margin:14px 0 6px;
}
.sIn {
  width:100%; background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.08); border-radius:8px;
  padding:9px 12px; color:#fff; font-size:.82rem;
  font-family:'DM Sans',sans-serif; outline:none;
}
.sIn:focus { border-color:rgba(138,180,248,.4); }
select.sIn option { background:#0a0a0f; }
.sSave {
  width:100%; padding:10px; border-radius:10px;
  background:#8ab4f8; color:#000; border:none;
  font-weight:600; font-size:.82rem; cursor:pointer;
  font-family:'DM Sans',sans-serif; margin-top:10px; transition:.15s;
}
.sSave:hover { opacity:.88; }
.sGhost {
  background:rgba(255,255,255,.06) !important; color:#666 !important;
  border:1px solid rgba(255,255,255,.08) !important;
  font-weight:400 !important;
}
.sGhost:hover { background:rgba(255,255,255,.11) !important; color:#fff !important; }
.sDvd { border:none; border-top:1px solid rgba(255,255,255,.05); margin:14px 0; }

/* â”€â”€ TOAST â”€â”€ */
#toast {
  position:fixed; bottom:160px; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,.82); border:1px solid rgba(255,255,255,.1);
  border-radius:12px; padding:9px 20px; font-size:.77rem; color:#ccc;
  z-index:300; opacity:0; transition:opacity .3s;
  pointer-events:none; white-space:nowrap; font-family:'DM Mono',monospace;
}
#toast.on { opacity:1; }
</style>
</head>
<body>

<!-- CAMERA â€” always full screen -->
<video id="vid" autoplay playsinline muted></video>
<div class="vig"></div><div id="gTop"></div><div id="gBot"></div>

<!-- HUD corners -->
<div class="hc tl" id="c0"></div><div class="hc tr" id="c1"></div>
<div class="hc bl" id="c2"></div><div class="hc br" id="c3"></div>

<div id="flash"></div>

<!-- ORB -->
<div id="orbWrap">
  <div id="orbGlow"></div>
  <div id="orb" class="idle"></div>
</div>

<!-- Reply -->
<div id="replyArea">
  <div id="replyTxt"></div>
  <div id="wave">
    <div class="wb"></div><div class="wb"></div><div class="wb"></div>
    <div class="wb"></div><div class="wb"></div><div class="wb"></div>
    <div class="wb"></div>
  </div>
</div>
<div id="status"></div>

<!-- Top bar -->
<div id="logo">
  <div id="logoMark">âœ¦</div>
  <div id="logoName">FRIDAY</div>
  <div id="livePill"><div id="liveDot"></div>LIVE</div>
</div>
<div id="wakeBadge">ðŸ”´ SAY "FRIDAY"</div>
<button id="gear" onclick="openS()">âš™</button>

<!-- Side buttons -->
<div id="side">
  <button class="sBtn" onclick="snapNow()">ðŸ“¸</button>
  <button class="sBtn" onclick="toggleMute()" id="muteBtn">ðŸ”Š</button>
</div>
<button id="flipBtn" onclick="flipCam()">ðŸ”„</button>

<!-- Mic -->
<div id="micWrap">
  <button id="mic" onclick="tapMic()">ðŸŽ¤</button>
  <div id="micLbl">Tap to talk</div>
</div>

<!-- Chips -->
<div id="chips">
  <div class="chip" id="chipCam">CAM OFF</div>
  <div class="chip" id="chipV">SAY "FRIDAY"</div>
</div>

<div id="toast"></div>

<!-- Settings -->
<div id="sOv" onclick="closeS()"></div>
<div id="sPan">
  <div class="sHead">
    <span>âš™ Settings</span>
    <button class="sClose" onclick="closeS()">âœ•</button>
  </div>

  <div class="sLbl">Chat Model</div>
  <select class="sIn" id="sModel">
    <option value="llama-3.3-70b-versatile">Llama 3.3 70B â€” best</option>
    <option value="llama-3.1-8b-instant">Llama 3.1 8B â€” fast</option>
    <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
  </select>

  <div class="sLbl">Vision Model</div>
  <select class="sIn" id="sVision">
    <option value="meta-llama/llama-4-scout-17b-16e-instruct">Llama 4 Scout</option>
    <option value="llama-3.2-11b-vision-preview">Llama 3.2 11B Vision</option>
  </select>

  <hr class="sDvd">

  <div class="sLbl">Voice</div>
  <select class="sIn" id="sVoice">
    <option value="en-IN">ðŸ‡®ðŸ‡³ Indian English</option>
    <option value="en-US">ðŸ‡ºðŸ‡¸ US English</option>
    <option value="en-GB">ðŸ‡¬ðŸ‡§ UK English</option>
    <option value="hi-IN">ðŸ‡®ðŸ‡³ Hindi</option>
  </select>

  <hr class="sDvd">

  <div class="sLbl">Personality</div>
  <textarea class="sIn" id="sPrompt" rows="5" style="resize:vertical;">You are Friday, a real-time AI voice assistant like JARVIS.
Speak in 1-3 short natural sentences only.
Never use lists or bullets â€” just talk naturally.
Say Boss occasionally. Be sharp and concise.</textarea>

  <hr class="sDvd">
  <button class="sSave" onclick="saveS()">âœ“ Save</button>
  <button class="sSave sGhost" style="margin-top:6px;" onclick="clearH()">Clear History</button>
  <div style="font-size:.56rem;color:#222;text-align:center;margin-top:14px;font-family:'DM Mono',monospace;">
    Friday v9 Â· Chrome only for voice
  </div>
</div>

<!-- START SCREEN -->
<div id="start">
  <div class="stOrb"></div>
  <div class="stTitle">FRIDAY</div>
  <div class="stSub">Full-screen camera Â· Say "Friday" to wake Â· Talks back to you</div>
  <button id="startBtn" onclick="boot()">â–¶ &nbsp; Start</button>
</div>

<script>
const GROQ_KEY = "__GROQ_KEY__";

const S = {
  history:  [],
  camTxt:   "",
  active:   false,
  speaking: false,
  muted:    false,
  stream:   null,
  facing:   "environment",
  wakeR:    null,
  talkR:    null,
  sTimer:   null,
  lastTalk: Date.now(),
};

// â”€â”€ BOOT â”€â”€
async function boot() {
  document.getElementById("start").classList.add("hide");

  // Camera
  try {
    S.stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:S.facing, width:{ideal:1920}, height:{ideal:1080} },
      audio:false
    });
    const vid = document.getElementById("vid");
    vid.srcObject = S.stream;
    await vid.play();
    vid.classList.add("dim");
    chipSet("chipCam","CAM ON");
    ["c0","c1","c2","c3"].forEach(x => document.getElementById(x).classList.add("on"));
  } catch(e) {
    chipSet("chipCam","NO CAM");
  }

  // Show UI
  setTimeout(() => {
    ["orbWrap","logo","gear","side","flipBtn","micWrap","chips","wakeBadge"]
      .forEach(x => document.getElementById(x).classList.add("on"));
  }, 400);

  // Start
  setTimeout(() => {
    startWake();
    speak("Friday online. Say my name to talk, Boss.");
  }, 900);
}

// â”€â”€ FLIP â”€â”€
async function flipCam() {
  S.facing = S.facing === "environment" ? "user" : "environment";
  if (S.stream) S.stream.getTracks().forEach(t => t.stop());
  try {
    S.stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:S.facing }, audio:false
    });
    document.getElementById("vid").srcObject = S.stream;
  } catch(e) { toast("Couldn't flip"); }
}

// â”€â”€ WAKE WORD â”€â”€
function startWake() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { chipSet("chipV","TAP MIC"); return; }
  try {
    S.wakeR = new SR();
    S.wakeR.lang = "en-US";
    S.wakeR.continuous = true;
    S.wakeR.interimResults = false;
    S.wakeR.onresult = e => {
      const t = e.results[e.results.length-1][0].transcript.toLowerCase();
      if (t.includes("friday")) activate();
    };
    S.wakeR.onerror = () => { if (!S.active) reWake(); };
    S.wakeR.onend   = () => { if (!S.active) reWake(); };
    S.wakeR.start();
  } catch(e) { chipSet("chipV","TAP MIC"); }
}
function reWake() {
  if (!S.active) setTimeout(() => { try{ S.wakeR.start(); }catch(e){} }, 300);
}

// â”€â”€ TAP MIC â”€â”€
function tapMic() {
  if (S.speaking) return;
  S.active ? sleep() : activate();
}

// â”€â”€ ACTIVATE â”€â”€
function activate() {
  if (S.active || S.speaking) return;
  try { S.wakeR && S.wakeR.stop(); } catch(e) {}
  S.active = true; S.lastTalk = Date.now();
  document.getElementById("wakeBadge").classList.remove("on");
  setOrb("listening"); setStatus("listening"); setMic("listening");
  chipSet("chipV","LISTENING");
  setText("Yes, Boss?");
  setTimeout(startConvo, 300);
}

// â”€â”€ CONVO â”€â”€
function startConvo() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { toast("Use Chrome browser for voice"); sleep(); return; }
  try {
    S.talkR = new SR();
    S.talkR.lang = "en-US";
    S.talkR.continuous = true;
    S.talkR.interimResults = false;
    S.talkR.onresult = e => {
      const txt = e.results[e.results.length-1][0].transcript;
      S.lastTalk = Date.now();
      setText('"' + txt + '"');
      setOrb("thinking"); setStatus("thinking"); setMic("thinking");
      chipSet("chipV","THINKING");
      askAI(txt);
    };
    S.talkR.onerror = () => { checkSilence(); };
    S.talkR.onend   = () => {
      if (S.active && !S.speaking)
        setTimeout(() => { try{ S.talkR.start(); }catch(e){} }, 200);
    };
    S.talkR.start();
    clearInterval(S.sTimer);
    S.sTimer = setInterval(() => {
      if (S.active && !S.speaking && Date.now() - S.lastTalk > 12000) sleep();
    }, 1000);
  } catch(e) { toast("Mic error â€” use Chrome"); sleep(); }
}

function checkSilence() {
  if (Date.now() - S.lastTalk > 12000 && S.active) sleep();
}

// â”€â”€ SLEEP â”€â”€
function sleep() {
  S.active = false;
  try { S.talkR && S.talkR.stop(); } catch(e) {}
  clearInterval(S.sTimer);
  setOrb("idle"); setStatus(""); setMic("idle");
  chipSet("chipV","SAY \"FRIDAY\"");
  setText("Say 'Friday' to wake me...");
  setTimeout(() => {
    setText("");
    document.getElementById("wakeBadge").classList.add("on");
    startWake();
  }, 2000);
}

// â”€â”€ SNAP â”€â”€
function snapNow() {
  const vid = document.getElementById("vid");
  if (!S.stream || !vid.videoWidth) { toast("Camera not on"); return; }
  const c = document.createElement("canvas");
  c.width = vid.videoWidth; c.height = vid.videoHeight;
  c.getContext("2d").drawImage(vid, 0, 0);
  const fl = document.getElementById("flash");
  fl.style.opacity = ".6"; setTimeout(() => fl.style.opacity = "0", 110);
  const b64 = c.toDataURL("image/jpeg",.85).split(",")[1];
  setOrb("thinking"); setStatus("analyzing"); setText("Analysing...");
  callVision(b64);
}

async function callVision(b64) {
  try {
    const r = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method:"POST",
      headers:{"Content-Type":"application/json","Authorization":"Bearer "+GROQ_KEY},
      body:JSON.stringify({
        model: document.getElementById("sVision").value,
        messages:[{role:"user",content:[
          {type:"image_url",image_url:{url:"data:image/jpeg;base64,"+b64}},
          {type:"text",text:"In 2-3 sentences: what do you see? Any problems? Quick recommendation. No lists, talk naturally."}
        ]}],
        max_tokens:200
      })
    });
    const d = await r.json();
    const result = d.choices[0].message.content.trim();
    S.camTxt = result;
    speak(result);
  } catch(e) { speak("Couldn't read image, Boss."); }
}

// â”€â”€ GROQ CHAT â”€â”€
async function askAI(text) {
  const sys = (document.getElementById("sPrompt").value)
    + "\nTime: " + new Date().toLocaleTimeString()
    + (S.camTxt ? "\n[Camera: " + S.camTxt.slice(0,200) + "]" : "");
  try {
    const r = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method:"POST",
      headers:{"Content-Type":"application/json","Authorization":"Bearer "+GROQ_KEY},
      body:JSON.stringify({
        model: document.getElementById("sModel").value,
        messages:[
          {role:"system",content:sys},
          ...S.history.slice(-8),
          {role:"user",content:text}
        ],
        max_tokens:180, temperature:0.75
      })
    });
    if (!r.ok) { const e=await r.json(); speak("Error: "+(e.error?.message||r.status)); return; }
    const d = await r.json();
    const reply = d.choices[0].message.content.trim();
    S.history.push({role:"user",content:text});
    S.history.push({role:"assistant",content:reply});
    if (S.history.length>20) S.history=S.history.slice(-20);
    speak(reply);
  } catch(e) { speak("Network error, Boss."); }
}

// â”€â”€ SPEAK â”€â”€
function speak(text) {
  S.lastTalk = Date.now();
  setText(text);
  setOrb("speaking"); setStatus("speaking"); setMic("speaking");
  document.getElementById("wave").classList.add("on");
  chipSet("chipV","SPEAKING");

  if (S.muted) { afterSpeak(); return; }

  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate=1.05; u.pitch=0.95; u.volume=1;
  const lang = document.getElementById("sVoice").value;
  u.lang = lang;
  const vv = speechSynthesis.getVoices();
  const pick = vv.find(v=>v.name.includes("Google")&&v.lang.startsWith(lang.split("-")[0]))
            || vv.find(v=>v.lang===lang)
            || vv.find(v=>v.lang.startsWith("en"))
            || vv[0];
  if (pick) u.voice = pick;
  S.speaking = true;
  u.onend = u.onerror = () => afterSpeak();
  speechSynthesis.speak(u);
}

function afterSpeak() {
  S.speaking = false; S.lastTalk = Date.now();
  document.getElementById("wave").classList.remove("on");
  if (S.active) {
    setOrb("listening"); setStatus("listening"); setMic("listening");
    chipSet("chipV","LISTENING"); setText("");
  } else {
    setOrb("idle"); setStatus(""); setMic("idle");
  }
}

// â”€â”€ UI HELPERS â”€â”€
function setOrb(s)  { document.getElementById("orb").className = s; }
function setText(t) {
  document.getElementById("replyTxt").textContent = t;
  document.getElementById("replyArea").classList.toggle("on",!!t);
}
function setStatus(t) {
  const el=document.getElementById("status");
  el.textContent=t; el.classList.toggle("on",!!t);
}
function setMic(s) {
  const m=document.getElementById("mic");
  m.classList.remove("listening","thinking","speaking");
  const ic={idle:"ðŸŽ¤",listening:"ðŸ”´",thinking:"â³",speaking:"ðŸ”Š"};
  m.textContent=ic[s]||"ðŸŽ¤";
  if(s!=="idle") m.classList.add(s);
  document.getElementById("micLbl").textContent=
    s==="idle"?"Tap to talk":s==="listening"?"Listening...":s==="thinking"?"Thinking...":"Speaking...";
}
function chipSet(id,t) { const el=document.getElementById(id); if(el)el.textContent=t; }
function toast(msg,ms=2500) {
  const el=document.getElementById("toast");
  el.textContent=msg; el.classList.add("on");
  setTimeout(()=>el.classList.remove("on"),ms);
}
function toggleMute() {
  S.muted=!S.muted;
  document.getElementById("muteBtn").textContent=S.muted?"ðŸ”‡":"ðŸ”Š";
  toast(S.muted?"Muted":"Unmuted âœ“");
}
function openS()  { document.getElementById("sPan").classList.add("on"); document.getElementById("sOv").classList.add("on"); }
function closeS() { document.getElementById("sPan").classList.remove("on"); document.getElementById("sOv").classList.remove("on"); }
function saveS()  { closeS(); toast("Saved âœ“"); }
function clearH() { S.history=[];S.camTxt="";setText("");closeS();toast("Cleared"); }

speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
document.addEventListener("keydown", e => {
  if (e.code==="Space"&&!e.target.matches("input,textarea,select")) { e.preventDefault(); snapNow(); }
});
</script>
</body>
</html>
